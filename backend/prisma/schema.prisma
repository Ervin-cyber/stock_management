generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  VIEWER
}

enum MovementType {
  IN
  OUT
  TRANSFER
}


model User {
  id                      String          @id @default(uuid())
  email                   String          @unique
  password                String      
  name                    String?     
  role                    Role      
  active                  Boolean         @default(true)

  // Prisma reverse relationship
  createdProducts         Product[]       @relation("ProductCreatedBy")
  updatedProducts         Product[]       @relation("ProductUpdatedBy")
  deletedProducts         Product[]       @relation("ProductDeletedBy")

  createdWarehouses       Warehouse[]     @relation("WarehouseCreatedBy")
  updatedWarehouses       Warehouse[]     @relation("WarehouseUpdatedBy")
  deletedWarehouses       Warehouse[]     @relation("WarehouseDeletedBy")

  createdMovements        StockMovement[] @relation("MovementCreatedBy")

  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  deletedAt               DateTime?       //soft-delete
}         

model Product {
  id                      String          @id @default(uuid())
  sku                     String          @unique
  name                    String      
  active                  Boolean         @default(true)
  description             String?

  stocks                  Stock[]
  movements               StockMovement[]

  createdById             String
  createdBy               User            @relation("ProductCreatedBy", fields: [createdById], references: [id])
                      
  updatedById             String?         
  updatedBy               User?           @relation("ProductUpdatedBy", fields: [updatedById], references: [id])
                      
  deletedById             String?       
  deletedBy               User?           @relation("ProductDeletedBy", fields: [deletedById], references: [id])

  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  deletedAt               DateTime?       //soft-delete
}   

model Warehouse {   
  id                      String          @id @default(uuid())
  name                    String          @unique
  location                String?
  active                  Boolean         @default(true)

  stocks                  Stock[]
  sourceMovements         StockMovement[] @relation("SourceMovements")
  destinationMovements    StockMovement[] @relation("DestinationMovements")

  createdById             String
  createdBy               User            @relation("WarehouseCreatedBy", fields: [createdById], references: [id])

  updatedById             String?         
  updatedBy               User?           @relation("WarehouseUpdatedBy", fields: [updatedById], references: [id])

  deletedById             String?       
  deletedBy               User?           @relation("WarehouseDeletedBy", fields: [deletedById], references: [id])

  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  deletedAt               DateTime?       //soft-delete
}   

model Stock {
  id                      String          @id @default(uuid())
  warehouseId             String          
  productId               String      
  stockQuantity           Int         

  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  warehouse               Warehouse       @relation(fields: [warehouseId], references: [id])
  product                 Product         @relation(fields: [productId], references: [id])

  @@unique([warehouseId, productId])
}

model StockMovement { //immutable
  id                      String          @id @default(uuid())
  productId               String  
  movementType            MovementType  
  sourceWarehouseId       String? 
  destinationWarehouseId  String? 
  stockQuantity           Int
  reference               String?
  description             String? 

  createdById             String
  createdBy               User            @relation("MovementCreatedBy", fields: [createdById], references: [id])
  createdAt               DateTime        @default(now())

  sourceWarehouse         Warehouse?      @relation("SourceMovements", fields: [sourceWarehouseId], references: [id])
  destinationWarehouse    Warehouse?      @relation("DestinationMovements", fields: [destinationWarehouseId], references: [id])
  product                 Product         @relation(fields: [productId], references: [id])
}
