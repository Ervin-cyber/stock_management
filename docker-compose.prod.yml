version: '3.8'
services:
#  postgres: #i will use my neon  pg db
#    image: postgres:15-alpine
#    container_name: stock-management-db
#    restart: unless-stopped
#    env_file:
#      - ./backend/.env
#    ports:
#      - "5432:5432"
#    volumes:
#      - pgdata:/var/lib/postgresql/data
#    healthcheck:
#      test: [ "CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-postgres} -d $${POSTGRES_DB:-stockdb}" ]
#      interval: 5s
#      timeout: 5s
#      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: stock-backend
    restart: unless-stopped
    env_file:
      - ./backend/.env
    environment:
      NODE_ENV: "production"
    ports:
      - "3000:3000"
    #depends_on:
    #        postgres:
    #          condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL}
    container_name: stock-frontend
    restart: unless-stopped
    ports:
      - "5173:80"
    depends_on:
      - backend
  
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: stock-cloudflare-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}

volumes:
  pgdata:
